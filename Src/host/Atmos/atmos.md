

# Описание
Система Atmos реализует симуляцию и распространение газов, воды и огня.
В текущей реализации 0.15.0 данная система имеет огромные накладыне расходы по производительности.
Обновление системы, описанное в этом файле объясняет как можно оптимизировать эту систему.

## Основные способы оптимизации
### Сервер
- создание и удаление объектов с низким сроком жизни с помощью hashmap objects
- формирование пакетов клиентам без лишних данных: айди и состояние
### Клиент
- отсечение рендеринга атмосферных частиц
- кешированное создание объектов для рендеринга освещения.
- прием от сервера упрощенных пакетов (айди чанка и состояние вместо полного пакета, принимаемого из NOEngine)

# Распределение зон
Для оптимизации чанков атмосферы их нужно разделить на сектора. причем из-за того, что атмос представлен в 3х мерном измерении чанки грузятся вокруг персонажа.

Первичный вариант: 11 чанков - 2 сверху и снизу, 1 в центре и по 1 с каждой стороны от персонажа
При смещении персонажа в новый чанк происходит перегрузка зоны.
Зоны представлены размером CHUNK_SIZE * CHUNK_AREA_SIZE - где размер зоны можно модифицировать через конфиг

# передача данных
Данные передаются большими пакетами. только в моменты обновления (1 раз в секунду)

Для минимизации отправки данных мы должны отправлять только айди чанков

Передача происходит по следующему алгоритму:
1. Клиент запрашивает зону. если зона не существует - она генерирует новую пустую зону.
2. Зона возвращает клиенту данные:
	[zoneid,lastupd,lastdel,id1,light_cfg,id2,light_cfg]
3. зона парсится. айди являются локальным смещением зоны. несколько айди могут применить несколько конфигов света (в будущем)
При обновлении следующее:
1. клиент отправляет запрос обновления с параметрами
	[netid,zoneid,ticktime]
2. сервер генерирует ответ.
	[zoneid,newticktime,lastdel,id1,-1,id2,light_cfg,id3,-1]
	следующий после айди флаг означает что нужно удалить конфигурации

Когда в зоне удаляется чанк и клиент возвращается в него:
1. клиент отправляет стандартный запрос обновления
	[netid,zoneid,ticktime]
2. сервер отдает стандартный пакет
	[zoneid,newticktime,lastdel,...]
3. смотрится значение lastdel. если оно отлично от юзерского времени последнего удаления то делаем 4
4. отправляем ещё реквест серверу на сверку
	[netid,zoneid,id1,id2...]
5. сервер генерирует ответный пакет формируя список на удаление.

## оптимизация отправки
у нас в каждой зоне есть 2 дельты
- время последнего изменения
- время последнего удаления
При обновлении зоны у каждого чанка с этого пакета обновляется метка последнего изменения.

# Правила кодирования пакетов
Все пакеты это последовательность чисел. Определенный набор чисел подразумевает разные условия декодирования. Заголовок пакета всегда примерно один и тот же. Пересчисление порядка элементов ниже:
- areaX - координата зоны X
- areaY - координата зоны Y
- areaZ - координата зоны Z
- lastUpdate - метка последнего обновления чанков в этой зоне. отрицательное число означает что это пакет обновления а не загрузки-запроса зоны.
- lastDelete - метка последнего удаления чанков в этой зоне. Если lastUpdate отрицательное число то этот параметр не включен в пакет.

далее идут пакеты чанков. их количество всегда кратно 2
localId - закодированный айди чанка. для преобразования в локальный айди относительно его зоны используйте atmos_decodeChId
lightConfig - конфигурация света. если это -1 то эффекты в этом чанке будут удалены.

## Вмещение нескольких зон
Так как на текущий момент зона это 10 чанков (может быть изменено в будущем), то в одной зоне хранится 1000 закодированных айди.
В случае когда нам нужно добавить несколько конфигов на один чанк мы должны использовать смещение.
Допустим, нам приходит пакет с айди чанка 20245. Если число больше максимального количества то делаем смещение:
20245%10000 -> 245 - это айди чанка
для понимания сколько следующих байт надо прочитать мы делим:
floor(20245/10000) -> 2 - это количество ячеек для чтения
Таким образом получается что получив пакет следующего вида:
> [20982,2042,2155] 
Мы загрузим на чанке с айди 982 конфиги освещения 2042 и 2155