# Система шаблонов лута

Данная система позволяет определять заранее заготовленные наборы лута, создаваемые в контейнерах при загрузке карты.

# Быстрый старт
Для создания нового файла с конфигурациями лута выполните следующие действия:
1. Создаем в `src\host\LootSystem\Collections` новый yml файл. Название должно отражать либо отдельный спавн (если в файле описан только он), либо название группы\категории спавнов. Например, в абстрактном файле `CaveClothes.yml` находились бы конфигурации лута, в котором спавнится одежда в пещерах.
2. Открываем наш файл и принимаемся описывать настройки спавнов. Подробнее о [схеме можно почитать](#описание-схемы) в разделе ниже.
3. В редакторе ReEditor выбираем нужный контейнер и в инспекторе (поле `Шаблон лута`) указываем наш конфиг.

# Принцип работы

Конфигурация лута содержит пул возможных предметов. Для спавна мы указываем сколько раз нам нужно пройтись по предметам.
Порядок выпадения следующий:
1. Определяем количество "проходов" по списку. Один проход это один выбор из списка предметов.
2. Выбирается случайный элемент списка items на основе их весов (указанных вероятностей).
3. Создаем предмет(ы) в соотвествии с указанными настойками.

# Описание схемы

Конфигурации лута определяются в yml файлах.
Пример конфигурации ниже:

```yml
TestLoot: # имя конфига. Оно указывается в инспекторе в свойстве "Шаблон лута"
  name: some name # Описательное название конфигурации (опционально)
  
  # тэг конфига. в объектах на карте можно указывать тег вместо имени чтобы система сама выбирала случайный конфиг из списка с одинаковым тегом
  # Тег обязательно должен содержать точку
  tag: .common_loot

  # ограничения по доступным картам и режимам. Эти разделы отвечают за то на каких картах и режимах доступен шаблон лута.
  # если опции не указаны - нет ограничений
  # проверки по ограничениям могут быть с помощью регулярных выражений, названия и наследования типа
  # типы проверок могут быть комбинированы
  maps:
    - regex: .*Map[1-9] #шаблон может быть использован если соответствует паттерну: несколько любых символов (.*), потом Map и потом цифра от 1 до 9 ([1-9]).
    - name: TestMap # шаблон может быть использован если название карты полностью соответствует указанному названию (TestMap)
    - TestMap # если нужно ограничение по названию, то name: можно не указывать
  gamemodes:
    - typeof: ScriptedGamemode # шаблон может быть использован если режим унаследован от ScriptedGamemode
    # можно указать несколько разных названий режимов
    - GMTemplate
    - GMExtended
  
  # Определяют состояние заспавненных предметов. Эти 2 свойства могут быть переопределены на каждом предмете
  # Допускаются вероятности в диапазоне - диапазон срабатывает для каждого заспавненного предмета
  health: 30% # сколько процентов повреждения получат предметы. 100 - без повреждений. 10 - почти уничтоженное
  quality: 50% # 50 стандартное качество (среднячок). 100 легендарное.

  # сколько раз проходимся по предметам. Это отвечает сколько заходов делается по предметам
  # простым языком - это число отражает количество предметов, которые могут появиться (без учета количества count у самих предметов)
  pass_count: 1 # может быть случайным диапазоном {min: X, max: Y}

  items:
    Item:
      name: Overriden name # новое имя заспавненного предмета
      prob: 35% # вероятность присутствия в пуле

      health: {min: 80%, max: 100%} #переопределяем качество. в случайном диапазоне
      quality: 100% # переопределяем качество. Без переопределения оно бы принимало значение 50%

      # диапазон количества предметов. Это число отвечает за то сколько заспавнится за один проход. По умолчанию 1
      count: 
        min: 1 
        max: 3 #ranged count
    Key:
      prob: 100%
      name: "Тест-ключ"
      count: 4 #fixed count
```

## Общие настройки

### Имя конфига
Имя корневого элемента это название шаблона лута, которое мы указываем в инспекторе свойства "Шаблон лута" для контейнеров. У вас не может быть создано несколько конфигов с одинаковым именем. Несколько контейнеров могут использовать одну и ту же конфигурацию.
Например, по [примеру выше](#описание-схемы) определен один шаблон лута с именем `TestLoot`.

### name
Это просто псевдонимное имя конфига использующеся при разработке в редакторе. Его можно не указывать.

### tag
Специальный тег для группировки нескольких шаблонов в один набор. Данная опция позволяет выбирать случайный шаблон лута с этим тегом. Т.е. мы можем создать 3 набора: ClothCave, ClothArmy, ClothCity и присвоить им один общий тег `.clothes`. После этого в редакторе ReEditor для контейнера указываем этот тег и при загрузке карты в контейнере появится лут из одного набора (выбирается случайно каждый раз).

#### Обратите внинмаие!
Теги должны содержать символ точку (`.`) для избежания конфликтов имён между именами конфигов и тегами.

### maps
Это свойство отвечает за карты, на которых может использоваться набор лута. Указанные опции задают **допустимые** карты, которые могут использовать этот конфиг. 

Типы опций для карт:
- **name** - полное сравнение по названию. Если ключ опции не указан, то значение так же интерпретируется как имя.
- **regex** - сопоставление с шаблоном регулярного выражения.
- **typeof** - сопоставление с родительским типом. Доступно только в [ограничениях на режимы](#modes)

```yml
# задаем ограничения по картам
# этот шаблон лута разрешен на картах с одним из названий: Minimap, Dirtpit и Detective
maps:
  - Minimap
  - name: Dirtpit # name: опционально для полного сравнения по названию
  - Detective
```

### gamemodes
Это свойство отвечает за режимы, на которых может использоваться набор лута. Указанные опции задают **допустимые** режимы, которые могут использовать этот конфиг.

Типы опций для режимов:
- **name** - полное сравнение по названию. Если ключ опции не указан, то значение так же интерпретируется как имя.
- **regex** - сопоставление с шаблоном регулярного выражения.
- **typeof** - сопоставление с родительским типом.

```yml
# задаем ограничения по режимам
# этот шаблон лута разрешен на только на режимах: которые унаследованы от ScriptedGamemode, называются GM_TestGamemode или называются GMExtended 
gamemodes:
  - typeof: ScriptedGamemode # сравнение по типу. режим должен быть унаследован от ScriptedGamemode
  - name: GM_TestGamemode # название режима должно соответствовать свойству name
  - GMExtended # тоже самое что и "- name: GMExtended"
```

### health

Какое здоровье будет у заспавненных предметов. Указывается процентное значение от 0 до 100, где 100 - отличное состояние. Допускается возможность указания диапазона, чтобы для каждого нового предмета устанавливалось случайное здоровье:

```yaml
# предметы будут иметь 30 процентов от своего стандартного здоровья
health: 30%

# каждый из предметов будет иметь от 40 до 60 процентов от своего стандартного здоровья
health:
  min: 40%
  max: 60%
```

### quality

Состояние\качество предмета отвечает за то сколько он может выдержать повреждений, прежде чем будет разрушен. Так же это отвечает за абстрактную ценность предмета. Стандартный предмет имеет качество 50%. Самый легендарный 100%. Сделанный из плохих материалов 10%.

```yaml
# предметы будут иметь стандартное качество
quality: 50%

# каждый из предметов будет иметь качество от стандартного до супер-плохого.
quality:
  min: 1%
  max: 50%
```

### pass_count

Отвечает за количество проходов по набору игровых предметов ([см. след. раздел](#items)). По умолчанию равно 1. Можно указать число, а можно диапазон чисел.

```yml
# будут выбраны 2 позиции из пула предметов
pass_count: 2 

# будет выбрано от 3 до 6 позиций
pass_count:
  min: 3
  max: 6

# one-line вариант
pass_count: {min: 3, max: 6}

```


### items

Набор игровых предметов, которые могут быть заспавнены в контейнере.
Ключ каждого элемента набора должен являться реальным класснеймом. Значенем является группа опций.

Если Вам нужно определить несколько предметов с одинаковыми предметами, отличающимися на 1 цифру:
```yml
items:
  Cloth1:
    prob: 100%
  Cloth2:
    prob: 100%
  Cloth3:
    prob: 100%
  Cloth4:
    prob: 100%
  Cloth5:
    prob: 100%
  Cloth6:
    prob: 100%
  # ...
```

Для удобства их можно определить следующим образом:
```yml
items:
  Cloth(1-6):
    prob: 100%
```

#### name

Новое имя предмета. Необязательный параметр.

#### all_types_of

При включении этой опции в список предметов автоматически будут добавлены все дочерние типы от текущего, в котором определен `all_types_of`. Из этого списка будет **исключён** тип, в котором включено `all_types_of`.

```yml
# При условии что:
# | Food
# |
#  \___ Testo
#      |
#       \___ Bread
#       \___ Pie
#  \___ Meat
#      |
#       \___ Kotleta

items:
  Food:
    prob: 40%
    all_types_of: true

# При компиляции лута преобразуется в:
items:
  Testo:
    prob: 40%
  Bread:
    prob: 40%
  Pie:
    prob: 40%
  Meat:
    prob: 40%
  Kotleta:
    prob: 40%
```

#### prob

Вероятность (вес) предмета в каждом проходе. Может быть как процентным числом, так и диапазоном процентных чисел.

#### count

Количество создаваемых предметов в одном проходе. По умолчанию 1.
Может быть как процентным числом, так и диапазоном процентых чисел.

#### quality

Позволяет изменить качество для предмета. Подробное описание по этой опции [смотрите выше](#quality)

#### health

Позволяет изменить здоровье предмета. Подробное описание по этой опции [смотрите выше](#health)

# Стандарты именований

Чтобы не утонуть в конфликтах имен и сложностях с запоминанием названий и расположением файлов разработаны простые стандарты по работе с файлами конфигов лута. 

Стандарты именований это **рекомендация** по правильному оформлению конфигов лута.

## Файлы конфигов

Файлы должны содержать однородные наборы. Это означает, что не стоит хранить в одном файле конфиги для оружия и одежды.

Имена файлов должны быть на английском языке с расширением `.yml` явно отражающие какие наборы лута лежат внутри.

Если ваши конфиги могут существовать только для одной карты\режима, то в папке Collections вы должны создать папку с именем вашей карты, в которой уже будут лежать ваши конфиги.

## Конфиги

Имена конфигов рекомендуется писать на английском языке без использования пробелов.

Имя конфига должно примерно отражать какой набор лута он содержит. 

Теги **должны** содержать символ точки в начале, например `.example`. Мы соблюдаем правило подразделов тегов (указанных через точки) для лучшего ориентирования и группировки наборов по принадлежности (`.weapons.melee.broken`).

Например, используйте тег `.clothes.civilian`, но не используйте `.civilian_clothes` или `.clothes_civilian`. 

# Тестирование наборов
Редактор ReEditor позволяет просматривать и тестировать шаблоны лута.
Для открытия утилиты тестирования шаблонов перейдите в `Инструменты -> Валидаторы -> Проверка шансов спавна лута`
![инструмент](https://cdn.discordapp.com/attachments/332611328470417409/1292233322877157407/image.png?ex=6702fd90&is=6701ac10&hm=490d4411f94d46685744ae438f01a8433e604bdf8e32e85dfd650c5296a49e18&)

В открывшемся окне сверху справа введите название шаблона либо название тега и нажмите кнопку внизу "Генерация". В центре экрана отобразится лут, который мог бы появиться. Нажмите снова для регенерации. 

Если вы что-то изменили в файлах конфигов и хотите увидеть результат изменений без перезапуска редактора нажмите кнопку "Перезагрузить шаблоны".

![тест](https://cdn.discordapp.com/attachments/332611328470417409/1292234176392724520/image.png?ex=6702fe5c&is=6701acdc&hm=6576d9204276f1b9f711abc3a26198451b33b4744d243c125b015e0ed53ec323&)
